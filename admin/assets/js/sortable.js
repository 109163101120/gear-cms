!function(a){a.fn.sortableLists=function(b){function l(b,c,d){k.isDragged=!0;var i=parseInt(c.css("margin-top")),j=parseInt(c.css("margin-bottom")),l=parseInt(c.css("margin-left")),o=parseInt(c.css("margin-right")),p=c.offset(),q=c.innerHeight();k.rootEl={el:d,offset:d.offset(),rootElClass:d.attr("class")},k.cEl={el:c,mT:i,mL:l,mB:j,mR:o,offset:p},k.cEl.xyOffsetDiff={X:b.pageX-k.cEl.offset.left,Y:b.pageY-k.cEl.offset.top},k.cEl.el.addClass("sortableListsCurrent "+e.currElClass),c.before(g);var r=k.placeholderNode=a("#sortableListsPlaceholder");c.css({width:c.width(),position:"absolute",top:p.top-i,left:p.left-l}).prependTo(f),r.css({display:"block",height:q}),h.css("height",q),k.doc.on("mousemove",m).on("mouseup",n)}function m(b){if(k.isDragged){var c=k.cEl,d=k.doc,f=k.win;b.pageX||r(b),d.scrollTop()>k.rootEl.offset.top-10&&b.clientY<50?k.upScroll?(b.pageY=b.pageY-e.scroll,a("html, body").each(function(b){a(this).scrollTop(a(this).scrollTop()-e.scroll)}),q(b)):o(b):d.scrollTop()+f.height()<k.rootEl.offset.top+k.rootEl.el.outerHeight(!1)+10&&f.height()-b.clientY<50?k.downScroll?(b.pageY=b.pageY+e.scroll,a("html, body").each(function(b){a(this).scrollTop(a(this).scrollTop()+e.scroll)}),q(b)):p(b):s(k),k.oElOld=k.oEl,c.el[0].style.visibility="hidden",k.oEl=oEl=u(b.pageX,b.pageY),c.el[0].style.visibility="visible",v(b,k),t(b,k)}}function n(b){var c=k.cEl,d=a("#sortableListsHint",k.rootEl.el),f=h[0].style,g=null,i=!1,l=a("#sortableListsHintWrapper");"block"==f.display&&d.length&&k.isAllowed?(g=d,i=!0):(g=k.placeholderNode,i=!1),offset=g.offset(),c.el.animate({left:offset.left-k.cEl.mL,top:offset.top-k.cEl.mT},250,function(){C(c),g.after(c.el[0]),g[0].style.display="none",f.display="none",d.remove(),l.removeAttr("id").removeClass(e.hintWrapperClass),l.length&&l.prev("div").append(j.clone(!0)),i?k.placeholderNode.slideUp(150,function(){k.placeholderNode.remove(),D(),e.onChange(c.el),e.complete(c.el),k.isDragged=!1}):(k.placeholderNode.remove(),D(),e.complete(c.el),k.isDragged=!1)}),s(k),k.doc.unbind("mousemove",m).unbind("mouseup",n)}function o(a){k.upScroll||(k.upScroll=setInterval(function(){k.doc.trigger("mousemove")},50))}function p(a){k.downScroll||(k.downScroll=setInterval(function(){k.doc.trigger("mousemove")},50))}function q(a){k.pY=a.pageY,k.pX=a.pageX,k.cY=a.clientY,k.cX=a.clientX}function r(a){a.pageY=k.pY,a.pageX=k.pX,a.clientY=k.cY,a.clientX=k.cX}function s(a){clearInterval(a.upScroll),clearInterval(a.downScroll),a.upScroll=a.downScroll=!1}function t(a,b){var c=b.cEl;c.el.css({top:a.pageY-c.xyOffsetDiff.Y-c.mT,left:a.pageX-c.xyOffsetDiff.X-c.mL})}function u(b,c){if(!document.elementFromPoint)return null;var d=k.isRelEFP;if(null===d){var e,f;(e=k.doc.scrollTop())>0&&(d=null==(f=document.elementFromPoint(0,e+a(window).height()-1))||"HTML"==f.tagName.toUpperCase()),(e=k.doc.scrollLeft())>0&&(d=null==(f=document.elementFromPoint(e+a(window).width()-1,0))||"HTML"==f.tagName.toUpperCase())}d&&(b-=k.doc.scrollLeft(),c-=k.doc.scrollTop());var g=a(document.elementFromPoint(b,c));return k.rootEl.el.find(g).length?g.is("#sortableListsPlaceholder")||g.is("#sortableListsHint")?null:g.is("li")?g.is("li")?g:void 0:(g=g.closest("li"),g[0]?g:null):null}function v(a,b){var c=b.oEl;if(c&&b.oElOld){var d=c.outerHeight(!1),f=a.pageY-c.offset().top;e.insertZonePlus?14>f?x(a,c,7>f):d-14<f&&z(a,c,d-7<f):5>f?w(a,c):d-5<f&&y(a,c)}}function w(b,c){if(a("#sortableListsHintWrapper",k.rootEl.el).length&&h.unwrap(),b.pageX-c.offset().left<e.insertZone){if(c.prev("#sortableListsPlaceholder").length)return void h.css("display","none");c.before(h)}else{var d=c.children(),f=c.children(e.listSelector).first();if(f.children().first().is("#sortableListsPlaceholder"))return void h.css("display","none");f.length?f.prepend(h):(d.first().after(h),h.wrap(i)),k.oEl&&A(c)}h.css("display","block"),k.isAllowed=e.isAllowed(k.cEl.el,h,h.parents("li").first())}function x(b,c,d){if(a("#sortableListsHintWrapper",k.rootEl.el).length&&h.unwrap(),!d&&b.pageX-c.offset().left>e.insertZone){var f=c.children(),g=c.children(e.listSelector).first();if(g.children().first().is("#sortableListsPlaceholder"))return void h.css("display","none");g.length?g.prepend(h):(f.first().after(h),h.wrap(i)),k.oEl&&A(c)}else{if(c.prev("#sortableListsPlaceholder").length)return void h.css("display","none");c.before(h)}h.css("display","block"),k.isAllowed=e.isAllowed(k.cEl.el,h,h.parents("li").first())}function y(b,c){if(a("#sortableListsHintWrapper",k.rootEl.el).length&&h.unwrap(),b.pageX-c.offset().left<e.insertZone){if(c.next("#sortableListsPlaceholder").length)return void h.css("display","none");c.after(h)}else{var d=c.children(),f=c.children(e.listSelector).last();if(f.children().last().is("#sortableListsPlaceholder"))return void h.css("display","none");f.length?d.last().append(h):(c.append(h),h.wrap(i)),k.oEl&&A(c)}h.css("display","block"),k.isAllowed=e.isAllowed(k.cEl.el,h,h.parents("li").first())}function z(b,c,d){if(a("#sortableListsHintWrapper",k.rootEl.el).length&&h.unwrap(),!d&&b.pageX-c.offset().left>e.insertZone){var f=c.children(),g=c.children(e.listSelector).last();if(g.children().last().is("#sortableListsPlaceholder"))return void h.css("display","none");g.length?f.last().append(h):(c.append(h),h.wrap(i)),k.oEl&&A(c)}else{if(c.next("#sortableListsPlaceholder").length)return void h.css("display","none");c.after(h)}h.css("display","block"),k.isAllowed=e.isAllowed(k.cEl.el,h,h.parents("li").first())}function A(a){a.removeClass("sortableListsClosed").addClass("sortableListsOpen"),a.children(e.listSelector).css("display","block");var b=a.children("div").children(".sortableListsOpener").first();"html"==e.opener.as?b.html(e.opener.close):"class"==e.opener.as?b.addClass(e.opener.close).removeClass(e.opener.open):b.css("background-image","url("+e.opener.close+")")}function B(a){a.removeClass("sortableListsOpen").addClass("sortableListsClosed"),a.children(e.listSelector).css("display","none");var b=a.children("div").children(".sortableListsOpener").first();"html"==e.opener.as?b.html(e.opener.open):"class"==e.opener.as?b.addClass(e.opener.open).removeClass(e.opener.close):b.css("background-image","url("+e.opener.open+")")}function C(a){var b=a.el[0].style;a.el.removeClass(e.currElClass+" sortableListsCurrent"),b.top="0",b.left="0",b.position="relative",b.width="auto"}function D(){a(e.listSelector,k.rootEl.el).each(function(b){a(this).children().length||(a(this).prev("div").children(".sortableListsOpener").first().remove(),a(this).remove())})}var c=a("body").css("position","relative"),d={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(c.css("margin-top")),left:0-parseInt(c.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!1,open:"",close:"",openerCss:{float:"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"",isAllowed:function(a,b,c){return!0},onDragStart:function(a,b){return!0},onChange:function(a){return!0},complete:function(a){return!0}},e=a.extend(!0,{},d,b),f=a("<"+e.listSelector+" />").prependTo(c).attr("id","sortableListsBase").css(e.baseCss).addClass(e.listsClass+" "+e.baseClass),g=a("<li />").attr("id","sortableListsPlaceholder").css(e.placeholderCss).addClass(e.placeholderClass),h=a("<li />").attr("id","sortableListsHint").css(e.hintCss).addClass(e.hintClass),i=a("<"+e.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(e.listsClass+" "+e.hintWrapperClass).css(e.listsCss).css(e.hintWrapperCss),j=a("<span />").addClass("sortableListsOpener "+e.opener.openerClass).css(e.opener.openerCss).on("mousedown",function(b){var c=a(this).closest("li");return c.hasClass("sortableListsClosed")?A(c):B(c),!1});"class"==e.opener.as?j.addClass(e.opener.close):"html"==e.opener.as&&j.html(e.opener.close);var k={isDragged:!1,isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:a(document),win:a(window)};if(e.opener.active){if(!e.opener.open)throw"Opener.open value is not defined. It should be valid url, html or css class.";if(!e.opener.close)throw"Opener.close value is not defined. It should be valid url, html or css class.";a(this).find("li").each(function(){var b=a(this);b.children(e.listSelector).length&&(j.clone(!0).prependTo(b.children("div").first()),b.hasClass("sortableListsOpen")?A(b):B(b))})}return this.on("mousedown",function(b){var c=a(b.target);if(!(k.isDragged!==!1||e.ignoreClass&&c.hasClass(e.ignoreClass))){b.preventDefault();var d=c.closest("li"),f=a(this);d[0]&&(e.onDragStart(b,d),l(b,d,f))}})},a.fn.sortableListsToArray=function(b,c){b=b||[];var d=0;return this.children("li").each(function(){var e=a(this),f={},g=e.attr("id");if(!g)throw console.log(e),"Previous item in console.log has no id. It is necessary to create the array.";f.id=g,f.parentId=c,f.value=e.data("value"),f.order=d,b.push(f),e.children("ul,ol").sortableListsToArray(b,g),d++}),b},a.fn.sortableListsToHierarchy=function(){var b=[],c=0;return a(this).children("li").each(function(){var d=a(this),e={},f=d.attr("id");if(!f)throw console.log(d),"Previous item in console.log has no id. It is necessary to create the array.";e.id=f,e.value=d.data("value"),e.order=c,b.push(e),e.children=d.children("ul,ol").sortableListsToHierarchy(),c++}),b},a.fn.sortableListsToString=function(b,c){return b=b||[],c=c||"no-parent",a(this).children("li").each(function(){var d=a(this),e=d.attr("id"),f=e?e.match(/(.+)[-=_](.+)/):null;if(!f)throw console.log(d),"Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string.";b.push(f[1]+"["+f[2]+"]="+c),a(this).children("ul,ol").sortableListsToString(b,f[2])}),b.join("&")}}(jQuery);
